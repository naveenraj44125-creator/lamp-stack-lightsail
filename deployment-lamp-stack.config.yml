# Generic Application Deployment Configuration for AWS Lightsail
# This file contains all configuration parameters for deploying any type of application

# AWS Configuration
aws:
  region: us-east-1
  
# Lightsail Instance Configuration
lightsail:
  instance_name: amazon-linux-test-v12-20251221
  static_ip: ""  # Will be assigned automatically
  
  # Instance size configuration (optional)
  # If not specified, defaults are: nano_3_0 (512MB) for traditional apps, small_3_0 (2GB) for Docker apps
  # LAMP stack with PostgreSQL + Redis + Apache + PHP may need more RAM for optimal performance
  # Available bundles: nano_3_0, micro_3_0, small_3_0, medium_3_0, large_3_0, xlarge_3_0, 2xlarge_3_0
  bundle_id: "small_3_0"  # 2GB RAM, 2 vCPU, 60GB SSD - Good performance for LAMP stack with multiple services
  
  # Operating system blueprint configuration (optional)
  # If not specified, defaults to ubuntu_22_04
  # Available blueprints: ubuntu_22_04, ubuntu_20_04, amazon_linux_2023, amazon_linux_2, centos_7_2009_01
  blueprint_id: "amazon_linux_2023"  # Amazon Linux 2023 - Testing Amazon Linux support with yum package manager
  
  # Lightsail Bucket Configuration (optional)
  bucket:
    enabled: true  # Set to true to create/attach a bucket
    name: "lamp-stack-demo-bucket"  # Bucket name (will be created if doesn't exist)
    access_level: "read_write"  # read_only or read_write
    # Bundle ID for bucket (optional, defaults to small_1_0)
    # small_1_0: 250GB storage, 100GB transfer
    # medium_1_0: 500GB storage, 250GB transfer
    # large_1_0: 1TB storage, 500GB transfer
    bundle_id: "small_1_0"
  
# Application Configuration
application:
  name: generic-app
  version: "3.0.0"
  type: web  # web, api, static, custom
  
  # Files to include in deployment package
  package_files:
    - "example-lamp-app/index.php"
    - "example-lamp-app/bucket-demo.php"
    - "example-lamp-app/bucket-manager.php"
    - "example-lamp-app/bucket-download.php"
    - "example-lamp-app/css/"
    - "example-lamp-app/config/"
  
  # Fallback: include all files if specific files don't exist
  package_fallback: true
  
  # Environment variables to set on the instance
  environment_variables:
    APP_ENV: production
    APP_DEBUG: false
    APP_NAME: "Generic Application"

# Dependencies Configuration - Each dependency can be enabled/disabled
dependencies:
  # Web Server Dependencies
  apache:
    enabled: true
    version: "latest"
    config:
      document_root: "/var/www/html"
      enable_ssl: false
      enable_rewrite: true
  
  nginx:
    enabled: false
    version: "latest"
    config:
      document_root: "/var/www/html"
      enable_ssl: false
  
  # Database Dependencies
  mysql:
    enabled: false  # Disabled - using PostgreSQL RDS instead
    external: true  # Set to true to use external RDS database (only installs mysql-client)
    rds:
      database_name: "lamp-app-db"  # Name of your Lightsail MySQL RDS instance
      region: "us-east-1"
      # Note: AWS credentials are automatically used from GitHub Actions
      # No need to specify access_key/secret_key here
      master_database: "app_db"  # Database name within RDS
      environment:
        DB_CONNECTION_TIMEOUT: "30"
        DB_CHARSET: "utf8mb4"
  
  postgresql:
    enabled: true  # Using PostgreSQL RDS
    external: true  # Using external RDS PostgreSQL
    rds:
      database_name: "lamp-app-postgres-db"  # Name of your Lightsail PostgreSQL RDS instance
      region: "us-east-1"
      master_database: "app_db"  # Database name within RDS
      environment:
        DB_CONNECTION_TIMEOUT: "30"
        DB_CHARSET: "utf8"
  
  # Programming Language Dependencies
  php:
    enabled: true
    version: "8.3"  # Updated to match Ubuntu 24.04 default
    config:
      extensions:
        # Note: pdo and json are built into PHP 8.3, no separate packages needed
        - "pgsql"      # Provides PDO PostgreSQL driver (php-pgsql)
        - "curl"       # HTTP client (php-curl)
        - "mbstring"   # Multibyte string support (php-mbstring)
        - "xml"        # XML support (php-xml)
        - "zip"        # ZIP archive support (php-zip)
        - "redis"      # Redis client (php-redis)
      enable_composer: true
  
  python:
    enabled: false
    version: "3.9"
    config:
      pip_packages:
        - "flask"
        - "gunicorn"
      virtual_env: true
  
  nodejs:
    enabled: false
    version: "18"
    config:
      npm_packages:
        - "express"
        - "pm2"
      package_manager: "npm"  # npm or yarn
  
  # Additional Dependencies
  redis:
    enabled: true
    version: "latest"
    config:
      bind_all_interfaces: false
  
  memcached:
    enabled: false
    version: "latest"
  
  docker:
    enabled: false
    version: "latest"
    config:
      enable_compose: true
  
  git:
    enabled: true
    config:
      install_lfs: false
  
  awscli:
    enabled: true
    version: "2"  # AWS CLI version: "1" or "2" (recommended)
    config:
      # AWS CLI will use IAM instance profile credentials automatically
      # No additional configuration needed for Lightsail bucket access
  
  # System Dependencies
  firewall:
    enabled: true
    config:
      allowed_ports:
        - "22"    # SSH
        - "80"    # HTTP
        - "443"   # HTTPS
      deny_all_other: true
  
  ssl_certificates:
    enabled: false
    config:
      provider: "letsencrypt"  # letsencrypt, custom
      domains: []
  
  monitoring:
    enabled: false
    config:
      tools:
        - "htop"
        - "iotop"
        - "netstat"

# Deployment Configuration
deployment:
  # Timeout settings (in seconds)
  timeouts:
    ssh_connection: 120
    command_execution: 300
    health_check: 180
  
  # Retry settings
  retries:
    max_attempts: 3
    ssh_connection: 5
  
  # Deployment steps configuration
  steps:
    pre_deployment:
      common:
        enabled: true
        update_packages: true
        create_directories: true
        backup_enabled: true
      dependencies:
        enabled: true
        install_system_deps: true
        configure_services: true
    
    post_deployment:
      common:
        enabled: true
        verify_extraction: true
        create_env_file: true
        cleanup_temp_files: true
      dependencies:
        enabled: true
        configure_application: true
        set_permissions: true
        restart_services: true
        optimize_performance: true
    
    verification:
      enabled: true
      health_check: true
      external_connectivity: true
      performance_test: true
      security_check: true
      endpoints_to_test:
        - "/"

# GitHub Actions Configuration
github_actions:
  # Trigger configuration
  triggers:
    push_branches:
      - main
      - master
    pull_request_branches:
      - main
      - master
    workflow_dispatch: true
  
  # Job configuration
  jobs:
    test:
      enabled: true
      language_specific_tests: true
      local_server_test: true
      test_port: 8000
    
    deployment:
      # Only deploy on main branch
      deploy_on_push: true
      deploy_on_pr: false
      
      # Artifact retention
      artifact_retention_days: 1
      
      # Deployment summary
      create_summary: true

# Monitoring and Logging
monitoring:
  # Health check configuration
  health_check:
    endpoint: "/"
    expected_content: "Hello"  # Generic content check
    max_attempts: 10
    wait_between_attempts: 10
    initial_wait: 30
  
  # Performance monitoring
  performance:
    response_time_check: true
    http_headers_check: true
  
  # Logging configuration
  logging:
    level: INFO
    include_timestamps: true
    include_deployment_metadata: true

# Security Configuration
security:
  # File permissions
  file_permissions:
    web_files: "644"
    directories: "755"
    config_files: "600"
  
  # Web server security (applies to enabled web server)
  web_server:
    hide_version: true
    disable_server_tokens: true
    enable_security_headers: true

# Backup Configuration
backup:
  enabled: true
  retention_days: 7
  backup_location: "/var/backups/deployments"
  include_database: false  # Set to true if database backups are needed
