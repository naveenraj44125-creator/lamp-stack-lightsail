name: Deploy LAMP Stack to Lightsail

on:
  push:
    branches: [ main, master ]
    paths:
      - 'lamp_stack_lightsail/**'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'lamp_stack_lightsail/**'
  workflow_dispatch:

env:
  LIGHTSAIL_INSTANCE_NAME: lamp-stack-demo
  LIGHTSAIL_STATIC_IP: 44.194.47.34
  AWS_REGION: us-east-1

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: pdo, pdo_mysql

    - name: Validate PHP syntax
      working-directory: ./lamp_stack_lightsail
      run: |
        find . -name "*.php" -exec php -l {} \;

    - name: Test PHP application
      working-directory: ./lamp_stack_lightsail
      run: |
        php -S localhost:8000 index.php &
        sleep 5
        curl -f http://localhost:8000/ || exit 1

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup Python environment
      run: |
        python3 -m pip install --upgrade pip
        python3 -m pip install boto3 paramiko

    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.LIGHTSAIL_SSH_PRIVATE_KEY }}" > ~/.ssh/lamp-stack-demo-key.pem
        chmod 600 ~/.ssh/lamp-stack-demo-key.pem
        ssh-keyscan -H ${{ env.LIGHTSAIL_STATIC_IP }} >> ~/.ssh/known_hosts

    - name: Deploy application to Lightsail
      working-directory: ./lamp_stack_lightsail
      run: |
        python3 deploy-lamp-stack.py \
          --instance-ip ${{ env.LIGHTSAIL_STATIC_IP }} \
          --ssh-key ~/.ssh/lamp-stack-demo-key.pem \
          --app-files "index.php,css/,config/" \
          --github-sha ${{ github.sha }} \
          --github-ref ${{ github.ref_name }} \
          --github-actor ${{ github.actor }} \
          --github-run-id ${{ github.run_id }}

    - name: Verify deployment
      run: |
        echo "Waiting for application to be ready..."
        sleep 30
        
        # Test the deployed application
        for i in {1..10}; do
          if curl -f -s http://${{ env.LIGHTSAIL_STATIC_IP }}/ | grep -q "Hello Welcome"; then
            echo "âœ… Application is working correctly!"
            echo "ðŸŒ Application URL: http://${{ env.LIGHTSAIL_STATIC_IP }}/"
            exit 0
          fi
          echo "Waiting for application to respond... ($i/10)"
          sleep 10
        done
        
        echo "âŒ Application verification failed"
        exit 1

    - name: Deployment Summary
      if: always()
      run: |
        echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Instance**: ${{ env.LIGHTSAIL_INSTANCE_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "- **IP Address**: ${{ env.LIGHTSAIL_STATIC_IP }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Application URL**: http://${{ env.LIGHTSAIL_STATIC_IP }}/" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployed by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployment Time**: $(date -u)" >> $GITHUB_STEP_SUMMARY
