name: Universal Deployment

on:
  workflow_dispatch:
    inputs:
      instance_name:
        description: 'Lightsail instance name'
        required: true
      app_type:
        description: 'Application type'
        required: true
        type: choice
        options:
          - php
          - python
          - nodejs
          - react
          - static
      config_file:
        description: 'Config file (optional)'
        required: false

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install boto3 paramiko
      
      - name: Package application
        run: |
          tar -czf app.tar.gz .
      
      - name: Deploy with universal script
        run: |
          python workflows/deploy-post-steps-universal.py \
            --instance-name "${{ github.event.inputs.instance_name }}" \
            --region "${{ secrets.AWS_REGION }}" \
            --package-file app.tar.gz \
            ${{ github.event.inputs.config_file && format('--config-file {0}', github.event.inputs.config_file) || '' }}
      
      - name: Deployment summary
        run: |
          echo "## ðŸŽ‰ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Instance**: ${{ github.event.inputs.instance_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **App Type**: ${{ github.event.inputs.app_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: ${{ secrets.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
