name: Test Enhanced Command Logging

on:
  workflow_dispatch:
  push:
    paths:
      - 'workflows/**'

jobs:
  test-enhanced-logging:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Setup Python environment
      run: |
        python3 -m pip install --upgrade pip
        python3 -m pip install boto3 pyyaml

    - name: Test Enhanced Logging
      run: |
        echo "üß™ Testing Enhanced Command Logging"
        echo "=================================="
        
        # Set GitHub Actions environment for enhanced logging
        export GITHUB_ACTIONS=true
        
        # Run the test script
        python3 workflows/test_detailed_logging.py

  test-deployment-steps:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Setup Python environment
      run: |
        python3 -m pip install --upgrade pip
        python3 -m pip install boto3 pyyaml

    - name: Create test package
      run: |
        echo "üì¶ Creating test package..."
        tar -czf test-app.tar.gz index.php css/ config/ || tar -czf test-app.tar.gz index.php || echo "Creating minimal package"
        ls -la test-app.tar.gz || echo "Package creation failed"

    - name: Test Pre-Deployment Steps
      run: |
        echo "üîß Testing Pre-Deployment Steps with Enhanced Logging"
        echo "===================================================="
        
        # Set GitHub Actions environment for enhanced logging
        export GITHUB_ACTIONS=true
        
        # Load instance name from config
        INSTANCE_NAME=$(python3 -c "import yaml; config=yaml.safe_load(open('deployment-generic.config.yml')); print(config['lightsail']['instance_name'])")
        AWS_REGION=$(python3 -c "import yaml; config=yaml.safe_load(open('deployment-generic.config.yml')); print(config['aws']['region'])")
        
        echo "üåç Instance: $INSTANCE_NAME"
        echo "üìç Region: $AWS_REGION"
        
        # Run pre-deployment steps
        python3 workflows/deploy-pre-steps-generic.py \
          --instance-name "$INSTANCE_NAME" \
          --region "$AWS_REGION" \
          --config-file deployment-generic.config.yml

    - name: Test Post-Deployment Steps
      run: |
        echo "üöÄ Testing Post-Deployment Steps with Enhanced Logging"
        echo "====================================================="
        
        # Set GitHub Actions environment for enhanced logging
        export GITHUB_ACTIONS=true
        
        # Load instance name from config
        INSTANCE_NAME=$(python3 -c "import yaml; config=yaml.safe_load(open('deployment-generic.config.yml')); print(config['lightsail']['instance_name'])")
        AWS_REGION=$(python3 -c "import yaml; config=yaml.safe_load(open('deployment-generic.config.yml')); print(config['aws']['region'])")
        
        echo "üåç Instance: $INSTANCE_NAME"
        echo "üìç Region: $AWS_REGION"
        echo "üì¶ Package: test-app.tar.gz"
        
        # Create a minimal package if needed
        if [ ! -f "test-app.tar.gz" ]; then
          echo "Creating minimal test package..."
          echo "<?php echo 'Hello from Enhanced Logging Test!'; ?>" > test-index.php
          tar -czf test-app.tar.gz test-index.php
        fi
        
        # Run post-deployment steps
        python3 workflows/deploy-post-steps-generic.py \
          test-app.tar.gz \
          --instance-name "$INSTANCE_NAME" \
          --region "$AWS_REGION" \
          --config-file deployment-generic.config.yml \
          --verify \
          --cleanup \
          --env GITHUB_TEST=true \
          --env ENHANCED_LOGGING=true

    - name: Test Deployment Monitor
      run: |
        echo "üè• Testing Deployment Monitor with Enhanced Logging"
        echo "=================================================="
        
        # Set GitHub Actions environment for enhanced logging
        export GITHUB_ACTIONS=true
        
        # Load instance name from config
        INSTANCE_NAME=$(python3 -c "import yaml; config=yaml.safe_load(open('deployment-generic.config.yml')); print(config['lightsail']['instance_name'])")
        AWS_REGION=$(python3 -c "import yaml; config=yaml.safe_load(open('deployment-generic.config.yml')); print(config['aws']['region'])")
        
        echo "üåç Instance: $INSTANCE_NAME"
        echo "üìç Region: $AWS_REGION"
        
        # Run health check
        python3 workflows/deployment_monitor.py \
          --instance-name "$INSTANCE_NAME" \
          --region "$AWS_REGION" \
          --config-file deployment-generic.config.yml \
          health