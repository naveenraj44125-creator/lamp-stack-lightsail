# MCP Server Deployment Configuration for AWS Lightsail
# Deploys the Lightsail Deployment MCP Server

# AWS Configuration
aws:
  region: us-east-1

# Lightsail Instance Configuration
lightsail:
  instance_name: mcp-server-lightsail
  static_ip: ""  # Will be fetched automatically from AWS

# Application Configuration
application:
  name: lightsail-mcp-server
  version: "1.0.0"
  type: nodejs
  
  # Files to include in deployment package
  package_files:
    - "mcp-server/"
  
  # Fallback: include all files if specific files don't exist
  package_fallback: true
  
  # Environment variables to set on the instance
  environment_variables:
    NODE_ENV: production
    PORT: "3000"
    MCP_AUTH_TOKEN: ""  # Will be generated during deployment

# Dependencies Configuration
dependencies:
  # Node.js is REQUIRED for MCP server
  nodejs:
    enabled: true
    config:
      version: "18"
      install_npm: true
      install_pm2: true  # Process manager for Node.js
  
  # Git for version control
  git:
    enabled: true
    config:
      install_lfs: false
  
  # System Dependencies
  firewall:
    enabled: true
    config:
      allowed_ports:
        - "22"    # SSH
        - "3000"  # MCP Server HTTP/SSE
      deny_all_other: true
  
  ssl_certificates:
    enabled: false
  
  monitoring:
    enabled: true
    config:
      install_cloudwatch: false

# Deployment Configuration
deployment:
  use_docker: false
  
  # Application path
  app_path: "/opt/mcp-server"
  
  backup_existing: true
  restart_services: true
  
  timeouts:
    ssh_connection: 120
    command_execution: 300
    health_check: 60
  
  retries:
    max_attempts: 3
    ssh_connection: 5
  
  steps:
    pre_deployment:
      common:
        enabled: true
        update_packages: true
        create_directories: true
        backup_enabled: true
      dependencies:
        enabled: true
        install_system_deps: true
        configure_services: true
    
    post_deployment:
      common:
        enabled: true
        verify_extraction: true
        create_env_file: true
        cleanup_temp_files: true
      dependencies:
        enabled: true
        configure_application: true
        set_permissions: true
        restart_services: true
    
    verification:
      enabled: true
      health_check: true
      external_connectivity: true
      port: 3000
      endpoints_to_test:
        - "/health"

# GitHub Actions Configuration
github_actions:
  triggers:
    push_branches:
      - main
      - master
    pull_request_branches:
      - main
      - master
    workflow_dispatch: true
  
  jobs:
    test:
      enabled: true
    
    deployment:
      deploy_on_push: true
      deploy_on_pr: false
      artifact_retention_days: 1
      create_summary: true

# Monitoring and Logging
monitoring:
  health_check:
    endpoint: "/health"
    port: 3000
    expected_content: "healthy"
    max_attempts: 10
    wait_between_attempts: 10
    initial_wait: 30
  
  service_health:
    check_service: true
    service_name: "mcp-server"

# Security Configuration
security:
  file_permissions:
    app_files: "644"
    directories: "755"
    config_files: "600"
  
  generate_auth_token: true

# Backup Configuration
backup:
  enabled: true
  retention_days: 7
  backup_location: "/var/backups/mcp-server"

# Notes:
# 1. The MCP server runs on port 3000
# 2. Authentication token is generated during deployment
# 3. PM2 manages the Node.js process
# 4. Access the server at http://your-ip:3000
